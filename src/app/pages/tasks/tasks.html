<div class="container mx-auto p-6 max-w-7xl"> <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-4 z-20">
    <div class="flex items-center gap-4">
      <button (click)="goBackcheck()" class="text-slate-400 hover:text-slate-600 transition flex items-center gap-1 text-sm font-bold">
        â† è¿”å›
      </button>
      <h2 class="text-xl font-bold text-slate-700 border-l border-slate-10 pl-4">
        ä»»å‹™æ¸…å–®
      </h2>
      <span class="text-xs text-slate-600 pl-4 mt-1">
          æœ€å¾Œæ›´æ–°ï¼š{{ lastUpdatedTime ? (lastUpdatedTime | date:'yyyy/MM/dd HH:mm') : 'ç„¡ç´€éŒ„' }}
        </span>
        <h2 class="text-xl font-bold text-slate-700 border-l border-slate-10 pl-4">
            åœ˜è™Ÿ:{{orderId}}
      </h2>
      <h2 class="text-xl font-bold text-slate-700 border-l border-slate-10 pl-4">
            åœ˜å:{{orderInfo.client_name || 'æœªå®šåœ˜å'}}
      </h2>
      <span class="text-xs text-slate-600 pl-4 mt-1">
          æ—…éŠæ—¥æœŸï¼š{{ orderInfo.start_date ? (orderInfo.start_date | date:'yyyy/MM/dd') : 'æœªå®š' }} - {{ orderInfo.end_date ? (orderInfo.end_date | date:'yyyy/MM/dd') : 'æœªå®š' }}    
      </span>
    </div>

    <div class="flex items-center gap-3">
      @if(isEditMode){
        <button 
  (click)="showImportModal = true"
  class="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg shadow-md transition ml-2">
  <mat-icon fontIcon="auto_awesome"></mat-icon> <span>AI æ™ºæ…§åŒ¯å…¥</span>
</button>

@if (showImportModal) {
  <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4">
    
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden border border-purple-200">
      
      <div class="bg-purple-50 p-4 border-b border-purple-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
          <mat-icon fontIcon="auto_awesome" class="scale-90"></mat-icon>
          æ™ºæ…§è¡Œç¨‹åŒ¯å…¥
        </h3>
        <button (click)="showImportModal = false" class="text-slate-400 hover:text-red-500">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>

      <div class="p-6 space-y-4">
        
        <p class="text-sm text-slate-500">
          ä½ å¯ä»¥è²¼ä¸Š JSON æ ¼å¼ï¼Œæˆ–æ˜¯ä¸Šå‚³æˆªåœ–è®“ AI å¹«ä½ æ•´ç†ã€‚
        </p>

        <div class="flex gap-2 mb-2">
            <label class="cursor-pointer px-3 py-3 bg-slate-100 hover:bg-slate-200 rounded text-sm text-slate-600 flex items-center gap-1 transition">
                <input type="file" (change)="onFileSelected($event)" class="hidden" accept="image/*">
                ğŸ¤– ä¸Šå‚³æˆªåœ–AIè¾¨è­˜
            </label>
        </div>

        <textarea 
          [(ngModel)]="importContent"
          rows="10" 
          class="w-full p-4 border border-slate-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"
          placeholder='ä¸Šå‚³æˆªåœ–æˆ–æ˜¯pngç…§ç‰‡æˆ–æ˜¯ç›´æ¥è²¼ä¸Š JSON Array:
            [{
              "day": 1,
              "time": "10:00",
              "item_name": "è¡Œç¨‹åç¨±",
              "remarks":"å‚™è¨»å…§å®¹",
              "contact_phone":"é›»è©±"
              }]
            å¯ä»¥æ¥æ­¤æ®µå°è©±çµ¦AIå«ä»–è½‰æ›'></textarea>

      </div>
      @if (isProcessingAi) {
  <div class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">
      <p>æ­£åœ¨ä¸Šå‚³çµ¦AIè¾¨è­˜...</p>
      <p>è«‹ç¨å€™ï¼Œä¸è¦é—œé–‰è¦–çª—</p>
      <p>éœ€ç´„30ç§’å·¦å³</p>
    </div>
  </div>
}
      <div class="bg-slate-50 p-4 border-t border-slate-100 flex justify-end gap-3">
        
        <!-- <button 
          (click)="callAiParser()"
          [disabled]="isProcessingAi || !importContent"
          class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg shadow hover:shadow-lg disabled:opacity-50 transition flex items-center gap-2">
          @if (isProcessingAi) {
            <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg>
            AI æ€è€ƒä¸­...
          } @else {
            ğŸ¤– AI è¾¨è­˜æ•´ç†
          }
        </button> -->

        <button 
          (click)="parseJson()"
          [disabled]="isProcessingAi || !importContent"
          class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition">
          ç¢ºèªåŒ¯å…¥è¡¨æ ¼
        </button>
      </div>

    </div>
  </div>
}
      }
      @if (isEditMode && (changedTasks.length > 0 || deletedTaskIds.size > 0)) {
        <button 
          (click)="saveChanges()"
          [disabled]="!canSave" 
          class="px-4 py-2 rounded-lg font-bold text-white transition shadow-md flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          [class.bg-blue-600]="!hasInvalidChanges"
          [class.hover:bg-blue-700]="!hasInvalidChanges"
          [class.bg-red-400]="hasInvalidChanges" 
        >
          @if (isSaving) {
            <span>è™•ç†ä¸­...</span>
          } @else if (hasInvalidChanges) {
            <span>âš ï¸ å„²å‚™è¨»åŠé›»è©±å…¶é¤˜æ¬„ä½çš†ç‚ºå¿…å¡«æ¬„ä½</span>
          } @else {
            <span>ğŸ’¾ å„²å­˜ </span>
          }
        </button>
      }
      
      @if(!isEditMode&& tasks.length > 0){ 
        <div class="relative inline-flex items-center justify-center gap-4 group">
  <div
    class="absolute inset-0 duration-1000 opacity-60 transitiona-all bg-gradient-to-r from-indigo-500 via-pink-500 to-yellow-400 rounded-xl blur-lg filter group-hover:opacity-100 group-hover:duration-200"
  ></div>

  <button
    (click)="exportToWord()"
    class="group relative inline-flex items-center justify-center text-base rounded-xl bg-gray-900 px-6 py-2 font-semibold text-white transition-all duration-200 hover:bg-gray-800 hover:shadow-lg hover:-translate-y-0.5 hover:shadow-gray-600/30"
    title="åŒ¯å‡ºè¡Œç¨‹è¡¨"
  >
    åŒ¯å‡º Word è¡Œç¨‹è¡¨
    
    <svg
      aria-hidden="true"
      viewBox="0 0 10 10"
      height="10"
      width="10"
      fill="none"
      class="mt-0.5 ml-2 -mr-1 stroke-white stroke-2"
    >
      <path
        d="M0 5h7"
        class="transition opacity-0 group-hover:opacity-100"
      ></path>
      <path
        d="M1 1l4 4-4 4"
        class="transition group-hover:translate-x-[3px]"
      ></path>
    </svg>
  </button>
</div>
}
      <button 
        (click)="toggleEditMode()"
        class="px-4 py-2 rounded-lg font-bold transition border flex items-center gap-2"
        [class.bg-slate-100]="!isEditMode"
        [class.text-slate-600]="!isEditMode"
        [class.bg-red-50]="isEditMode"
        [class.text-red-600]="isEditMode"
        [class.border-red-200]="isEditMode">
        {{ isEditMode ? 'âœ• å–æ¶ˆç·¨è¼¯' : 'âœï¸ ç·¨è¼¯æ¨¡å¼' }}
      </button>
    </div>
  </div>

  @if (isLoading) {
    <div class="text-center py-20 text-slate-500">æ­£åœ¨è®€å–ä»»å‹™è³‡æ–™...</div>
  } @else {
    
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden text-sm">
      <div class="grid grid-cols-24 gap-4 p-4 bg-slate-25 border-b border-slate-200 font-bold text-slate-600 text-center items-center">
        <div class="col-span-4 text-left pl-2">ç‹€æ…‹</div>
        <div class="col-span-2 ">å¤©æ•¸@if (hasInvalidChanges) {<span class="text-red-500">*</span>}</div>
        <div class="col-span-2">é¡åˆ¥@if (hasInvalidChanges) {<span class="text-red-500">*</span>}</div>
        <div class="col-span-3 text-left">ä»»å‹™é …ç›®@if (hasInvalidChanges) {<span class="text-red-500">*</span>}</div>
        <div class="col-span-2">æ™‚é–“@if (hasInvalidChanges) {<span class="text-red-500">*</span>}</div>
        <div class="col-span-3">é›»è©±@if (hasInvalidChanges) {<span class="text-red-500">*</span>}</div>
        <div class="col-span-4 text-left">å‚™è¨» / å•é¡Œ</div>
         <div class="col-span-2">æ›´æ–°äººå“¡</div>
        <div class="col-span-2">æ›´æ–°æ™‚é–“</div>
      </div>

      @for (task of tasks; track task.id) {
        <div class="grid grid-cols-24 gap-4 p-4 items-center border-b border-slate-100 transition duration-150 relative"
             [class.bg-red-50]="task.is_priority && !task.is_completed" 
             [class.bg-yellow-50]="task.has_issue && !task.is_priority && !task.is_completed"
             [class.bg-blue-50]="isTaskDirty(task)"
             [class.hover:bg-slate-50]="!task.is_priority && !task.has_issue">
          
          <div class="col-span-4 flex flex-col justify-center items-start pl-2">
            
            @if (isEditMode) {
              <div class="flex flex-col gap-2 w-full">
                
                <div class="flex items-center gap-2">
                  <input type="checkbox" [(ngModel)]="task.is_completed" 
                         class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                  <span class="text-sm font-bold text-slate-700">å®Œæˆ</span>
                   @if(isEditMode){
                        <button 
                            (click)="deleteTask(task)"
                            class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-red-600 hover:bg-red-50 transition color-red-50"
                            title="åˆªé™¤æ­¤ä»»å‹™">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                            </button>
                        }
                </div>
                
                <div class="flex flex-col gap-1 pl-1"> <div class="flex items-center gap-2">
                     <mat-slide-toggle 
                      [(ngModel)]="task.is_priority" 
                      color="warn" 
                      class="transform scale-75 origin-left">
                    </mat-slide-toggle>
                    <span class="text-xs text-slate-500 -ml-2 whitespace-nowrap">æ€¥ä»¶/å„ªå…ˆ</span>
                  </div>

                  <div class="flex items-center gap-2">
                    <mat-slide-toggle 
                      [(ngModel)]="task.has_issue" 
                      color="primary" 
                      class="transform scale-75 origin-left">
                    </mat-slide-toggle>
                    <span class="text-xs text-slate-500 -ml-2 whitespace-nowrap">ç‹€æ³/å•é¡Œ</span>
                  </div>
                  
                </div>
              </div>

            } @else {
                
              <div class="flex flex-col gap-1 items-start">
                @if (!task.is_priority && !task.is_completed || !task.has_issue && !task.is_completed) {
                 <div class="flex items-center gap-2 mb-1">
                            @if(isEditMode){
                    <input type="checkbox" [checked]="task.is_completed" disabled
                           class="w-5 h-5 rounded border-gray-300 text-gray-400 cursor-not-allowed">
                           }
                    @if(!task.is_priority&&!task.has_issue||!task.has_issue&&task.is_completed||task.has_issue&&!task.is_completed){       
                    <span class="text-sm font-bold text-slate-600">
                        {{ task.is_completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ' }}
                    </span>
                    }
                    
                 </div>
                
                 }
                 @if(!isEditMode&&task.is_completed){
                      <span class="text-sm font-bold text-slate-600">
                        å·²å®Œæˆ
                      </span>
                    }
                    @if(!isEditMode&&task.is_completed&&task.is_priority){
                        <span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold whitespace-nowrap">
                        ğŸ”¥ æ€¥ä»¶
                      </span>
                    }
                    @if(!isEditMode&&task.is_completed&&task.has_issue){
                        <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded-full border border-yellow-300 font-bold whitespace-nowrap">
                        âš ï¸ ç‹€æ³
                      </span>
                    }
                 <div class="flex flex-wrap gap-1">
                    @if (task.is_priority && !task.is_completed) {
                      <span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold whitespace-nowrap">
                        ğŸ”¥ æ€¥ä»¶
                      </span>
                    }
                    @if (task.has_issue && !task.is_completed) {
                      <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded-full border border-yellow-300 font-bold whitespace-nowrap">
                        âš ï¸ ç‹€æ³
                      </span>
                    }
                 </div>
              </div>
            }
          </div>

          <div class="col-span-2 flex justify-center">
            @if (isEditMode) {
              <select [(ngModel)]="task.day_number" class="w-full border border-slate-300 rounded-md py-1.5 px-2 bg-white text-center text-sm shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                @for (d of days; track d) {
                  <option [value]="d">{{ d }}</option>
                }
              </select>
            } @else {
              <span class="font-mono text-slate-600 bg-slate-100 rounded px-2 py-1 text-sm border border-slate-200">
                ç¬¬{{ task.day_number }}å¤©
              </span>
            }
          </div>

          <div class="col-span-2 flex justify-center">
            @if (isEditMode) {
              <select [(ngModel)]="task.category" class="w-full border border-slate-300 rounded-md py-1.5 px-2 bg-white text-sm shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                @for (cat of categories; track cat) {
                  <option [value]="cat">{{ cat }}</option>
                }
              </select>
            } @else {
              <span class="inline-block text-slate-700 font-medium bg-white px-2 py-1 rounded border border-slate-200 text-sm">
                {{ task.category }}
              </span>
            }
          </div>

          <div class="col-span-3">
            @if (isEditMode) {
              <input type="text" [(ngModel)]="task.item_name" class="w-full border border-blue-300 rounded-md py-1.5 px-3 text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition shadow-sm">
            } @else {
              <span class="font-bold text-slate-600 block text-base"
                 [class.text-slate-200]="task.is_completed" 
                 [class.text-slate-400]="task.is_completed">
                {{ task.item_name }}
              </span>
            }
          </div>

          <div class="col-span-2 pt-1 flex justify-center">
            @if (isEditMode) {
              <input type="time" [(ngModel)]="task.start_time" class="w-full border border-slate-300 rounded py-1 px-1 text-sm text-center">
            } @else {
              <span class="text-slate-600 font-mono text-sm">
                {{ task.start_time ? (task.start_time | slice:0:5) : 'å°šæœªè¨­å®š' }}
              </span>
            }
          </div>

          <div class="col-span-3 pt-1 text-left">
            @if (isEditMode) {
              <input type="text" [(ngModel)]="task.contact_phone" placeholder="é›»è©±..." class="w-full border border-slate-300 rounded py-1 px-2 text-sm">
            } @else {
              <div class="flex items-center justify-center gap-1 text-slate-600 text-sm">
                @if(task.contact_phone) {
                  
                  <a [href]="'tel:' + task.contact_phone" >
                    {{ task.contact_phone }}
                  </a>
                }
              </div>
            }
          </div>

          <div class="col-span-4 ">
            @if (isEditMode) {
              <textarea 
                  [(ngModel)]="task.remarks" 
                  rows="2"
                  placeholder="è¼¸å…¥å‚™è¨»..."
                  class="w-full border border-slate-200 rounded-md py-1.5 px-3 text-sm placeholder-slate-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition resize-y min-h-[40px]"
                  [class.bg-yellow-50]="task.remarks">
                </textarea>
            } @else {
             <span class="text-slate-500 block text-sm whitespace-pre-wrap  break-words "
                    >
                {{ task.remarks || '' }}
              </span>
            }
          </div>

          <div class="col-span-2 text-center text-sm text-slate-500 truncate">
            {{ task.assignee || '-' }}
          </div>

          <div class="col-span-2 text-center text-xs text-slate-400 leading-tight">
             @if (task.updated_at) {
               <div class="font-mono">{{ task.updated_at | date:'MM/dd' }}</div>
               <div class="font-mono">{{ task.updated_at | date:'HH:mm' }}</div>
             } @else {
               -
             }
          </div>

        </div>
      } @empty {
        <div class="p-10 text-center flex flex-col items-center justify-center text-slate-400 bg-slate-50">
          @if (!isEditMode) {
             <p class="text-lg">ğŸ“­ æ­¤è¨‚å–®ç›®å‰æ²’æœ‰ä»»å‹™ç´°ç¯€<br>é»é¸ä¸Šæ–¹ç·¨è¼¯æ¨¡å¼ä¾†æ–°å¢é …ç›®</p>
          }
          @if (isEditMode) {
             <button 
                (click)="addTask()"
                class="px-4 py-2 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 transition shadow-md flex items-center gap-2">
                <span>+ æ–°å¢ä»»å‹™</span>
            </button>
                }
                </div>
      }
      
    </div>
     @if (isEditMode) {
            <div class="mt-20 flex justify-center">
  <button 
    (click)="addTask()"
    class="group px-9 py-4 rounded-lg font-bold transition shadow-md flex items-center justify-center gap-2 animate-bounce
           bg-transparent border-2 border-green-600 text-green-600 
           hover:bg-green-600 hover:text-white">
    
    <mat-icon aria-hidden="false" fontIcon="add_circle" class="scale-110"></mat-icon>
    
    <span>æ–°å¢ä»»å‹™</span>
  </button>
</div>
                }
  }
</div>